//
//  CategoriesShowViewController.swift
//  OmnieCommerce
//
//  Created by msm72 on 09.11.16.
//  Copyright (c) 2016 Omniesoft. All rights reserved.
//
//  This file was generated by the Clean Swift Xcode Templates so you can apply
//  clean architecture to your iOS and Mac projects, see http://clean-swift.com
//

import UIKit

// MARK: - Input protocols for current ViewController component VIP-cicle
protocol CategoriesShowViewControllerInput {
    func categoriesDidShowLoad(fromViewModel viewModel: CategoriesShowModels.Categories.ViewModel)
}

// MARK: - Output protocols for Interactor component VIP-cicle
protocol CategoriesShowViewControllerOutput {
    func categoriesDidLoad(withRequestModel requestModel: CategoriesShowModels.Categories.RequestModel)
}

class CategoriesShowViewController: BaseViewController {
    // MARK: - Properties
    var interactor: CategoriesShowViewControllerOutput!
    var router: CategoriesShowRouter!
    
    // Outlets
    @IBOutlet weak var cityView: UIView!
    @IBOutlet weak var smallTopBarView: SmallTopBarView!
    @IBOutlet weak var dataSourceEmptyView: UIView!
    
    @IBOutlet weak var cityButton: DropDownButton!
    
    @IBOutlet weak var collectionView: MSMCollectionView! {
        didSet {
            collectionView.contentInset = UIEdgeInsetsMake(0, 0, 0, 0)
            collectionView.scrollIndicatorInsets = UIEdgeInsetsMake(0, 0, 0, 0)
        }
    }

    
    // MARK: - Class Initialization
    override func awakeFromNib() {
        super.awakeFromNib()
        
        CategoriesShowConfigurator.sharedInstance.configure(viewController: self)
    }
    

    // MARK: - Class Functions
    override func viewDidLoad() {
        super.viewDidLoad()
        
        viewSettingsDidLoad()
    }
    
    
    // MARK: - Actions
    @IBAction func handlerCityButtonTap(_ sender: DropDownButton) {
        print(object: "\(type(of: self)): \(#function) run.")
        
        // TODO: - UNCOMMENT WHEN USE CITY DROPDOWN LIST
        /*
        (sender.isDropDownListShow) ? sender.itemsListDidHide(inView: view) : sender.itemsListDidShow(inView: view)
        (sender.dropDownTableVC.tableView as! CustomTableView).setScrollIndicatorColor(color: UIColor.veryLightOrange)
        
        // Handler DropDownList selection
        sender.dropDownTableVC.completionHandler = ({ selectedObject in
            sender.changeTitle(newValue: selectedObject.name)
            
            sender.itemsListDidHide(inView: self.view)
        })
         */
    }
    
    
    // MARK: - Custom Functions
    func viewSettingsDidLoad() {
        print(object: "\(type(of: self)): \(#function) run.")
        
        // Config topBarView
        navigationBarView = smallTopBarView
        smallTopBarView.type = "Parent"
        haveMenuItem = true
        
        // Load Categories list from CoreData
        guard isNetworkAvailable else {
            self.categoriesListDidShow()
            
            // TODO: - ADD LOAD CITIES LIST FROM COREDATA
            return
        }
        
        // Load Categories list from API
        spinnerDidStart(nil)
        
        let categoriesParameters: [String: Any] = [ "locale": Locale.current.languageCode!.lowercased() ]
        let categoriesRequestModel = CategoriesShowModels.Categories.RequestModel(parameters: categoriesParameters)
        interactor.categoriesDidLoad(withRequestModel: categoriesRequestModel)
    }

    func categoriesListDidShow() {
        // Setting MSMCollectionViewControllerManager
        collectionView.collectionViewControllerManager = MSMCollectionViewControllerManager(withCollectionView: self.collectionView)
        collectionView.collectionViewControllerManager!.sectionsCount = 1
        
        let categoriesList = CoreDataManager.instance.entitiesDidLoad(byName: "Category",
                                                                      andPredicateParameters: NSPredicate(format: "categoriesList.name == %@", keyCategories))
        
        if let categories = categoriesList as? [Category] {
            collectionView.collectionViewControllerManager!.dataSource = categories
            dataSourceEmptyView.isHidden = (categories.count == 0) ? false : true
            
            collectionView.reloadData()
            self.collectionViewCellDidSelect()
        }
        
        spinnerDidFinish()
    }
    
    private func collectionViewCellDidSelect() {
        collectionView.collectionViewControllerManager!.handlerCellSelectCompletion = { item in
            switch item {
            case (let category as Category):
                // Transition to OrganizationsShow scene with selected Category value
                self.router.navigateToOrganizationsShowScene(withCategory: category)

            default:
                break
            }
        }
    }
    
    // MARK: - Transition
    override func viewWillTransition(to size: CGSize, with coordinator: UIViewControllerTransitionCoordinator) {
        smallTopBarView.setNeedsDisplay()
        smallTopBarView.circleView.setNeedsDisplay()
        
        // TODO: - UNCOMMENT WHEN USE CITY DROPDOWN LIST
        /*
         cityButton.setNeedsDisplay()
         
         if (cityButton.isDropDownListShow) {
         cityButton.itemsListDidHide(inView: view)
         }
         */
        
        collectionView.reloadData()
    }
}


// MARK: - CategoriesShowViewControllerInput
extension CategoriesShowViewController: CategoriesShowViewControllerInput {
    func categoriesDidShowLoad(fromViewModel viewModel: CategoriesShowModels.Categories.ViewModel) {
        // Check for errors
        guard viewModel.status == "SUCCESS" else {
            self.alertViewDidShow(withTitle: "Error", andMessage: viewModel.status, completion: {
                self.categoriesListDidShow()
            })
            
            return
        }
        
        self.categoriesListDidShow()
    }
}
